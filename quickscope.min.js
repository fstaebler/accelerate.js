pps=irfs=0;ppw=pph=512;filterA=.96;zoomtarget=12;zoom=10;deltaxtarget=deltax=.25;deltaytarget=deltay=.5;mixf=.2;drawScene=()=>{zoom=mixf*zoomtarget+(1-mixf)*zoom;deltax=mixf*deltaxtarget+(1-mixf)*deltax;deltay=mixf*deltaytarget+(1-mixf)*deltay;aspect=window.innerWidth/window.innerHeight;requestAnimationFrame(drawScene);g.bindFramebuffer(36160,ppfb);g.useProgram(p);g.framebufferTexture2D(36160,36064,3553,(pps?pp1:pp2),0);g.activeTexture(33984);g.bindTexture(3553,pps?pp2:pp1);g.uniform1i(p.inTex,0);g.uniform1f(p.h,pph);g.uniform1f(p.w,ppw);g.bindBuffer(34962,dummyBuffer);g.viewport(0,0,ppw,pph);g.vertexAttribPointer(p.vertexPositionAttribute,3,5126,0,0,0);g.drawArrays(5,0,4);g.useProgram(t);g.bindFramebuffer(36160,postfxfb);g.activeTexture(33984);g.bindTexture(3553,pps?pp2:pp1);g.uniform1i(t.inTex,0);g.activeTexture(33985);g.bindTexture(3553,colormaptex);g.uniform1i(t.colormap,1);g.uniform1f(t.rampY,(Date.now()/(30000*colormaps.length))%1);g.uniformMatrix3fv(t.projection,0,[aspect/zoom,0,deltax*aspect,0,1/zoom,deltay,0,0,1]);g.bindBuffer(34962,dummyBuffer);g.viewport(0,0,ppw,pph);g.vertexAttribPointer(p.vertexPositionAttribute,3,5126,0,0,0);g.drawArrays(5,0,4);g.useProgram(f);g.bindFramebuffer(36160,irffb);g.framebufferTexture2D(36160,36064,3553,(irfs?irf1:irf2),0);g.activeTexture(33984);g.bindTexture(3553,irfs?irf2:irf1);g.uniform1i(f.inTexLast,0);g.activeTexture(33985);g.bindTexture(3553,postfxtex);g.uniform1i(f.inTexCurrent,1);g.uniform1f(f.a,filterA);g.uniform1f(f.ar,aspect);g.bindBuffer(34962,dummyBuffer);g.viewport(0,0,ppw,pph);g.vertexAttribPointer(p.vertexPositionAttribute,3,5126,0,0,0);g.drawArrays(5,0,4);g.useProgram(postproc);g.bindFramebuffer(36160,null);g.activeTexture(33984);g.bindTexture(3553,irfs?irf1:irf2);g.uniform1i(postproc.inTex,0);g.bindBuffer(34962,dummyBuffer);g.viewport(0,0,window.innerWidth,window.innerHeight);g.vertexAttribPointer(p.vertexPositionAttribute,3,5126,0,0,0);g.drawArrays(5,0,4);pps=!pps;irfs=!irfs;};j=()=>{_c=document.getElementsByTagName("canvas")[0];_c.height=window.innerHeight;_c.width=window.innerWidth;g=_c.getContext("webgl");var fragmentShader=g.createShader(35632);g.shaderSource(fragmentShader,"precision highp float;uniform sampler2D inTex;varying vec2 vUv;uniform float w;uniform float h;bool ia(vec3 c){return(c.g>.3);}const float tau=6.2831853;void main(){vec3 ns[8];float xsize=.8/w;float ysize=.8/h;float j=0.;ns[0]=texture2D(inTex,vUv+vec2(-xsize,-ysize)).rgb;ns[1]=texture2D(inTex,vUv+vec2(0.,-ysize)).rgb;ns[2]=texture2D(inTex,vUv+vec2(xsize,-ysize)).rgb;ns[3]=texture2D(inTex,vUv+vec2(-xsize,0.)).rgb;ns[4]=texture2D(inTex,vUv+vec2(xsize,0.)).rgb;ns[5]=texture2D(inTex,vUv+vec2(-xsize,ysize)).rgb;ns[6]=texture2D(inTex,vUv+vec2(0.,ysize)).rgb;ns[7]=texture2D(inTex,vUv+vec2(xsize,ysize)).rgb;vec3 me=texture2D(inTex,vUv).rgb;float trs=0.;float trc=0.;if(ia(ns[0])){j+=1.;trs+=sin(ns[0].r*tau);trc+=cos(ns[0].r*tau);}if(ia(ns[1])){j+=1.;trs+=sin(ns[1].r*tau);trc+=cos(ns[1].r*tau);}if(ia(ns[2])){j+=1.;trs+=sin(ns[2].r*tau);trc+=cos(ns[2].r*tau);}if(ia(ns[3])){j+=1.;trs+=sin(ns[3].r*tau);trc+=cos(ns[3].r*tau);}if(ia(ns[4])){j+=1.;trs+=sin(ns[4].r*tau);trc+=cos(ns[4].r*tau);}if(ia(ns[5])){j+=1.;trs+=sin(ns[5].r*tau);trc+=cos(ns[5].r*tau);}if(ia(ns[6])){j+=1.;trs+=sin(ns[6].r*tau);trc+=cos(ns[6].r*tau);}if(ia(ns[7])){j+=1.;trs+=sin(ns[7].r*tau);trc+=cos(ns[7].r*tau);}bool ima=ia(me);if(((j==2.||j==6.)&&ima)||(!ima&&(j==2.||j==3.))){if(ima){j+=1.;trs+=sin(me.r*tau);trc+=cos(me.r*tau);}float avgRs=trs/j;float avgRc=trc/j;gl_FragColor=vec4(mod(atan(avgRs,avgRc)/tau,1.),1.,1.,1.);}else{gl_FragColor=vec4(0.,0.,0.,1.);}}");g.compileShader(fragmentShader);var fragmentShader2=g.createShader(35632);g.shaderSource(fragmentShader2,"precision highp float;uniform sampler2D inTex;uniform sampler2D colorRamp;uniform float rampY;varying vec2 vUv;uniform mat3 projection;void main(){vec2 tcoord=vUv-vec2(.5);vec2 rcoord=(vec3(tcoord,1.)*projection).xy;vec4 col=texture2D(inTex,rcoord);if(col.g>.5){gl_FragColor=sqrt(texture2D(colorRamp,vec2(col.r,rampY)));}else{gl_FragColor=vec4(0.,0.,0.,1.);}}");g.compileShader(fragmentShader2);var fragmentShader3=g.createShader(35632);g.shaderSource(fragmentShader3,"precision highp float;uniform sampler2D inTex;varying vec2 vUv;vec2 distort(vec2 v,float o){v=(v*2.)-1.;v=v*o*.975;return(v*.5)+.5;}vec3 weighted_av(vec4 c,vec3 w){return c.rgb*w;}void main(){vec3 res=texture2D(inTex,vUv).rgb;res*=12.;res+=texture2D(inTex,vUv+vec2(.004,0.)).rgb;res+=texture2D(inTex,vUv+vec2(-.004,0.)).rgb;res+=texture2D(inTex,vUv+vec2(.008,0.)).rgb;res+=texture2D(inTex,vUv+vec2(-.008,0.)).rgb;res+=texture2D(inTex,vUv+vec2(.012,0.)).rgb;res+=texture2D(inTex,vUv+vec2(-.012,0.)).rgb;res+=texture2D(inTex,vUv+vec2(.002,0.)).rgb;res+=texture2D(inTex,vUv+vec2(-.002,0.)).rgb;res+=texture2D(inTex,vUv+vec2(.006,0.)).rgb;res+=texture2D(inTex,vUv+vec2(-.006,0.)).rgb;res+=texture2D(inTex,vUv+vec2(.010,0.)).rgb;res+=texture2D(inTex,vUv+vec2(-.010,0.)).rgb;res/=24.;gl_FragColor=vec4(res,1.);}");g.compileShader(fragmentShader3);var irfshader=g.createShader(35632);g.shaderSource(irfshader,"precision highp float;uniform sampler2D inTexCurrent;uniform sampler2D inTexLast;uniform float a;uniform float ar;varying vec2 vUv;void main(){float val=.0008;vec3 res=texture2D(inTexCurrent,vUv).rgb;vec3 old=texture2D(inTexLast,vUv+vec2(val,0.)).rgb;old+=texture2D(inTexLast,vUv-vec2(val,0.)).rgb;old+=texture2D(inTexLast,vUv+vec2(0.,val*ar)).rgb;old+=texture2D(inTexLast,vUv-vec2(0.,val*ar)).rgb;old/=3.9;old=1.01*old-.01;gl_FragColor=vec4(max(res,old*a),1.);}");g.compileShader(irfshader);var vertexShader=g.createShader(35633);g.shaderSource(vertexShader,"attribute vec3 pos;varying vec2 vUv;void main(){vUv=(pos.xy+1.)*.5;gl_Position=vec4(pos,1.);}");g.compileShader(vertexShader);p=g.createProgram();t=g.createProgram();postproc=g.createProgram();f=g.createProgram();g.attachShader(f,vertexShader);g.attachShader(f,irfshader);g.attachShader(p,vertexShader);g.attachShader(t,vertexShader);g.attachShader(postproc,vertexShader);g.attachShader(p,fragmentShader);g.attachShader(t,fragmentShader2);g.attachShader(postproc,fragmentShader3);g.linkProgram(p);g.linkProgram(t);g.linkProgram(postproc);g.linkProgram(f);f.inTexLast=g.getUniformLocation(f,"inTexLast");f.inTexCurrent=g.getUniformLocation(f,"inTexCurrent");f.a=g.getUniformLocation(f,"a");f.ar=g.getUniformLocation(f,"ar");p.vertexPositionAttribute=g.getAttribLocation(p,"pos");g.enableVertexAttribArray(p.vertexPositionAttribute);p.inTex=g.getUniformLocation(p,"inTex");p.h=g.getUniformLocation(p,"h");p.w=g.getUniformLocation(p,"w");t.inTex=g.getUniformLocation(t,"inTex");t.projection=g.getUniformLocation(t,"projection");t.colormap=g.getUniformLocation(t,"colorRamp");t.rampY=g.getUniformLocation(t,"rampY");postproc.inTex=g.getUniformLocation(postproc,"inTex");dummyBuffer=g.createBuffer();g.bindBuffer(34962,dummyBuffer);g.bufferData(34962,new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0]),35044);tb=new Uint8Array(ppw*pph*4);fill=()=>{bs=512;for(var y=(pph-bs)/2;(pph-bs)/2+bs>y;y+=1){for(var x=(ppw-bs)/2;(ppw-bs)/2+bs>x;x+=1){var i=(y*ppw+x)*4;tb[i]=Math.random()*255;tb[i+1]=Math.random()*255;tb[i+2]=Math.random()*0;tb[i+3]=255;}}};fill();colormaps=[(x)=>{x/=256/6;var n=x%1;var m=1-n;n*=255;m*=255;if(1>x)return[255,n,0];if(2>x)return[m,255,0];if(3>x)return[0,255,n];if(4>x)return[0,m,255];if(5>x)return[n,0,255];return[255,0,m];},(x)=>{if(8>x%16)return[0,0,0];return[255,255,255];},(x)=>{x/=40.743665;var n=Math.sin(x)*64;var m=Math.cos(x)*64;return[128+n,128+m,128];},(x)=>{x/=128/6;var n=x%1;var m=1-n;n*=255;m*=255;x%=6;if(1>x)return[255,n,0];if(2>x)return[m,255,0];if(3>x)return[0,255,n];if(4>x)return[0,m,255];if(5>x)return[n,0,255];return[255,0,m];}];colormapbuf=new Uint8Array(256*colormaps.length*4);for(var i=0;colormaps.length>i;i++){for(var x=0;256>x;x++){_p=(i*256+x)*4;_c=colormaps[i](x);colormapbuf[_p]=_c[0];colormapbuf[_p+1]=_c[1];colormapbuf[_p+2]=_c[2];colormapbuf[_p+3]=255;}}colormaptex=g.createTexture();g.bindTexture(3553,colormaptex);g.texParameteri(3553,10240,9729);g.texParameteri(3553,10241,9729);g.texParameteri(3553,10242,10497);g.texParameteri(3553,10243,10497);g.texImage2D(3553,0,6408,256,colormaps.length,0,6408,5121,colormapbuf);postfxtex=g.createTexture();g.bindTexture(3553,postfxtex);g.texParameteri(3553,10240,9729);g.texParameteri(3553,10241,9729);g.texParameteri(3553,10242,10497);g.texParameteri(3553,10243,10497);g.texImage2D(3553,0,6408,ppw,pph,0,6408,5121,null);postfxrb=g.createRenderbuffer();g.bindRenderbuffer(36161,postfxrb);g.renderbufferStorage(36161,33189,ppw,pph);postfxfb=g.createFramebuffer();g.bindFramebuffer(36160,postfxfb);g.bindTexture(3553,postfxtex);g.framebufferTexture2D(36160,36064,3553,postfxtex,0);g.framebufferRenderbuffer(36160,36096,36161,postfxrb);pp1=g.createTexture();g.bindTexture(3553,pp1);g.texParameteri(3553,10240,9728);g.texParameteri(3553,10241,9728);g.texParameteri(3553,10242,10497);g.texParameteri(3553,10243,10497);g.texImage2D(3553,0,6408,ppw,pph,0,6408,5121,null);g.texSubImage2D(3553,0,0,0,pph,ppw,6408,5121,tb);pp2=g.createTexture();g.bindTexture(3553,pp2);g.texParameteri(3553,10240,9728);g.texParameteri(3553,10241,9728);g.texParameteri(3553,10242,10497);g.texParameteri(3553,10243,10497);g.texImage2D(3553,0,6408,ppw,pph,0,6408,5121,null);g.texSubImage2D(3553,0,0,0,pph,ppw,6408,5121,tb);irf1=g.createTexture();g.bindTexture(3553,irf1);g.texParameteri(3553,10240,9729);g.texParameteri(3553,10241,9729);g.texParameteri(3553,10242,33071);g.texParameteri(3553,10243,33071);g.texImage2D(3553,0,6408,ppw,pph,0,6408,5121,null);irf2=g.createTexture();g.bindTexture(3553,irf2);g.texParameteri(3553,10240,9729);g.texParameteri(3553,10241,9729);g.texParameteri(3553,10242,33071);g.texParameteri(3553,10243,33071);g.texImage2D(3553,0,6408,ppw,pph,0,6408,5121,null);ppdb=g.createRenderbuffer();g.bindRenderbuffer(36161,ppdb);g.renderbufferStorage(36161,33189,ppw,pph);irffb=g.createFramebuffer();g.bindFramebuffer(36160,irffb);g.bindTexture(3553,irfs?irf1:irf2);g.framebufferTexture2D(36160,36064,3553,(irfs?irf1:irf2),0);g.framebufferRenderbuffer(36160,36096,36161,ppdb);g.bindTexture(3553,null);ppfb=g.createFramebuffer();g.bindFramebuffer(36160,ppfb);g.bindTexture(3553,pps?pp1:pp2);g.framebufferTexture2D(36160,36064,3553,(pps?pp1:pp2),0);g.framebufferRenderbuffer(36160,36096,36161,ppdb);g.bindTexture(3553,null);g.clearColor(.5,0,0,1);drawScene();};onresize=()=>{var _canvas=document.getElementsByTagName("canvas")[0];_canvas.height=innerHeight;_canvas.width=innerWidth;};onkeypress=(e)=>{if(e.key=="r")restart();};onwheel=function(e){zoomtarget+=(e.deltaY*.01*zoomtarget);zoomtarget=Math.min(Math.max(.8,zoomtarget),50);};lastx=lasty=0;onmousemove=(e)=>{if(e.buttons&1){deltaxtarget+=(lastx-e.clientX)/innerWidth/zoom;deltaytarget-=(lasty-e.clientY)/innerHeight/zoom;}lastx=e.clientX;lasty=e.clientY;};restart=()=>{fill();g.bindTexture(3553,pp1);g.texSubImage2D(3553,0,0,0,pph,ppw,6408,5121,tb);g.bindTexture(3553,pp2);g.texSubImage2D(3553,0,0,0,pph,ppw,6408,5121,tb);console.log("Reset.");};